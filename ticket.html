<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Paradise Ticket</title>
<style>
body{font-family:sans-serif;background:#050614;color:white;padding:20px;display:flex;flex-direction:column;align-items:center;}
#status{margin-bottom:20px;font-size:18px;}
#messages{width:100%;max-width:600px;background:#0f0f1f;padding:12px;border-radius:10px;min-height:300px;overflow-y:auto;margin-bottom:12px;}
.message{padding:8px 10px;margin-bottom:6px;border-radius:8px;background:#111217;}
.message.staff{background:#7c3aed;color:white;}
.message.user{background:#06b6d4;color:white;}
input,button{padding:10px;border-radius:6px;border:none;}
input{flex:1;margin-right:6px;background:#111217;color:white;}
#sendBtn{background:#7c3aed;color:white;cursor:pointer;}
#inputWrapper{display:flex;width:100%;max-width:600px;}
</style>
</head>
<body>

<h1>Paradise Ticket</h1>
<div id="status">Loading ticket...</div>
<div id="messages"></div>
<div id="inputWrapper">
<input type="text" id="msgInput" placeholder="Type your message..." />
<button id="sendBtn">Send</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyAWqZClZUwdAoiRXNlWDWFdx2ggrmxdWSE",
    authDomain: "paradise-community.firebaseapp.com",
    databaseURL: "https://paradise-community-default-rtdb.firebaseio.com/",
    projectId: "paradise-community",
    storageBucket: "paradise-community.firebasestorage.app",
    messagingSenderId: "967977031344",
    appId: "1:967977031344:web:6408921ddbd62559f84d75"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Utils
function getTicketId(){
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
}

// Elements
const statusEl = document.getElementById('status');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');

let ticketId = getTicketId();
if(!ticketId){ statusEl.innerText="Invalid ticket URL"; document.getElementById('inputWrapper').style.display='none'; }

// Render messages
function renderMessage(msg){
    const div = document.createElement('div');
    div.className = 'message ' + (msg.sender==='staff'?'staff':'user');
    div.innerText = msg.text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Load ticket and listen for updates
const ticketRef = db.ref('tickets/'+ticketId);
ticketRef.on('value', snapshot=>{
    const t = snapshot.val();
    if(!t){ statusEl.innerText="Ticket not found"; inputEl.disabled=true; sendBtn.disabled=true; return; }
    statusEl.innerText = `Ticket Status: ${t.status.toUpperCase()}`;
    if(t.status==='closed'){ inputEl.disabled=true; sendBtn.disabled=true; }
});

// Messages
const msgsRef = db.ref('tickets/'+ticketId+'/messages');
msgsRef.on('value', snapshot=>{
    messagesEl.innerHTML='';
    const msgs = snapshot.val() || {};
    Object.values(msgs).forEach(renderMessage);
});

// Send message
sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

function sendMessage(){
    const text = inputEl.value.trim();
    if(!text) return;
    const msgData = {text, sender:'user', ts:Date.now()};
    const newMsgRef = msgsRef.push();
    newMsgRef.set(msgData);
    ticketRef.update({lastUpdated:Date.now()}); // update last activity for auto-close
    inputEl.value='';
}
</script>
</body>
</html>
