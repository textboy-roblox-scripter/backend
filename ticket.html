<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paradise Ticket</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#0d0d0d; color:white; padding:20px; }
    #messages { max-height: 400px; overflow-y: auto; border: 1px solid #444; padding: 10px; margin-bottom: 10px; }
    .message { margin-bottom: 8px; padding: 6px; border-radius: 6px; }
    .user { background: #1e1e2f; }
    .staff { background: #2e1e3f; }
    #messageInput { width: 80%; padding: 6px; }
    button { background:#6b46c1; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button:hover { background:#805ad5; }
    #closeTicket { background:#c53030; margin-top:10px; display:none; }
  </style>
</head>
<body>
  <h2>Support Ticket</h2>

  <div id="messages"></div>

  <input type="text" id="messageInput" placeholder="Type your message...">
  <button id="sendBtn">Send</button>

  <button id="closeTicket">Close Ticket</button>

  <script type="module">
    // --- Firebase Config (Your Project) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAWqZClZUwdAoiRXNlWDWFdx2ggrmxdWSE",
      authDomain: "paradise-community.firebaseapp.com",
      databaseURL: "https://paradise-community-default-rtdb.firebaseio.com/",
      projectId: "paradise-community",
      storageBucket: "paradise-community.firebasestorage.app",
      messagingSenderId: "967977031344",
      appId: "1:967977031344:web:6408921ddbd62559f84d75"
    };

    // Init
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Hardcoded staff usernames
    const staffUsers = ["Admin123", "HelperBot", "StaffUser"];

    // Ticket ID from URL query (e.g. ?Id=abc123)
    const urlParams = new URLSearchParams(window.location.search);
    const ticketId = urlParams.get("Id") || "ticket_1";

    const messagesDiv = document.getElementById("messages");
    const sendBtn = document.getElementById("sendBtn");
    const messageInput = document.getElementById("messageInput");
    const closeBtn = document.getElementById("closeTicket");

    let currentUser = null;
    let ticketClosed = false;

    // Fake login for demo (replace with Google/Email auth later)
    auth.signInAnonymously().then(() => {
      currentUser = { displayName: "GuestUser" };
    });

    // Watch ticket status
    db.collection("tickets").doc(ticketId)
      .onSnapshot(doc => {
        if (doc.exists) {
          const data = doc.data();
          if (data.status === "closed") {
            ticketClosed = true;
            sendBtn.disabled = true;
            messageInput.disabled = true;
            closeBtn.style.display = "none";
          }
        }
      });

    // Load messages
    db.collection("tickets").doc(ticketId).collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        messagesDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const role = staffUsers.includes(msg.username) ? "staff" : "user";
          const div = document.createElement("div");
          div.className = `message ${role}`;
          div.innerHTML = `<strong>${msg.username}:</strong> ${msg.text}`;
          messagesDiv.appendChild(div);
        });
      });

    // Send message
    sendBtn.addEventListener("click", () => {
      const text = messageInput.value.trim();
      if (text && currentUser && !ticketClosed) {
        db.collection("tickets").doc(ticketId).collection("messages").add({
          username: currentUser.displayName,
          text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        messageInput.value = "";
      }
    });

    // Show close ticket button if staff
    auth.onAuthStateChanged(user => {
      if (user) {
        const uname = user.displayName || "GuestUser";
        if (staffUsers.includes(uname)) {
          closeBtn.style.display = "block";
        }
      }
    });

    // Close ticket
    closeBtn.addEventListener("click", () => {
      db.collection("tickets").doc(ticketId).set({ status: "closed" }, { merge: true });
      alert("Ticket closed by staff!");
    });
  </script>
</body>
</html>